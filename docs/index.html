<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AkbayMed Documentation</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="css/styles.css">
    
    <!-- Prism.js for code highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fira+Code:wght@400;500&family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <nav class="sidebar">
            <div class="sidebar-header">
                <img src="assets/images/akbaymed-logo.png" alt="AkbayMed Logo" class="logo" />
            </div>
            
            <div class="sidebar-content">
                <ul class="nav-links">
                    <li>
                        <a href="#getting-started"><i class="fas fa-rocket"></i> Getting Started</a>
                        <ul>
                            <li><a href="#introduction">Introduction</a></li>
                            <li><a href="#installation">Installation</a></li>
                            <li><a href="#env-config">Environment Configuration</a></li>
                            <li><a href="#prerequisites">Prerequisites</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#features"><i class="fas fa-star"></i> Features</a>
                        <ul>
                            <li><a href="#authentication">Authentication</a></li>
                            <li><a href="#medication-donation">Medication Donation</a></li>
                            <li><a href="#medication-requests">Medication Requests</a></li>
                            <li><a href="#user-profile">User Profile</a></li>
                            <li><a href="#home-dashboard">Home Dashboard</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#tech-stack"><i class="fas fa-layer-group"></i> Tech Stack</a>
                        <ul>
                            <li><a href="#frontend">Frontend</a></li>
                            <li><a href="#backend">Backend</a></li>
                            <li><a href="#dependencies">Dependencies</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#api-integration"><i class="fas fa-code"></i> API Integration</a>
                        <ul>
                            <li><a href="#openfda-api">openFDA API</a></li>
                            <li><a href="#supabase-integration">Supabase Integration</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#database"><i class="fas fa-database"></i> Database</a>
                        <ul>
                            <li><a href="#tables">Tables</a></li>
                            <li><a href="#table-relationships">Table Relationships</a></li>
                            <li><a href="#key-features">Key Features</a></li>
                            <li><a href="#database-functions">Database Functions</a>
                                <ul>
                                    <li><a href="#donation-count">Donation Count</a></li>
                                    <li><a href="#donation-appointment">Donation Appointment</a></li>
                                    <li><a href="#request-appointment">Request Appointment</a></li>
                                    <li><a href="#inventory-management">Inventory Management</a></li>
                                </ul>
                            </li>
                            <li><a href="#row-level-security">Row Level Security</a></li>
                            <li><a href="#storage-configuration">Storage Configuration</a></li>
                            <li><a href="#error-handling">Error Handling</a></li>
                        </ul>
                    </li>
                    <li>
                        <a href="#ui-ux"><i class="fas fa-paint-brush"></i> UI/UX Design</a>
                        <ul>
                            <li><a href="#design-system">Design System</a></li>
                            <li><a href="#color-scheme">Color Scheme</a></li>
                            <li><a href="#typography">Typography</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-wrapper">
                <!-- Getting Started Section -->
                <section id="getting-started">
                    <div class="section-header">
                        <i class="fas fa-rocket"></i>
                        <h2>Getting Started</h2>
                    </div>
                    
                    <div id="introduction" class="card">
                        <h3>Introduction</h3>
                        <p>
                            AkbayMed is a Flutter-based Android application designed to facilitate medication donation
                            and distribution in Philippine healthcare centers. The app connects donors with patients
                            in need, ensuring safe and transparent medicine redistribution.
                        </p>
                        <div class="feature-grid">
                            <div class="feature-card">
                                <i class="fas fa-hand-holding-medical"></i>
                                <h4>Medication Donation</h4>
                                <p>Easy and secure way to donate medications</p>
                            </div>
                            <div class="feature-card">
                                <i class="fas fa-user-md"></i>
                                <h4>Patient Support</h4>
                                <p>Connect patients with needed medications</p>
                            </div>
                            <div class="feature-card">
                                <i class="fas fa-shield-alt"></i>
                                <h4>Safe Distribution</h4>
                                <p>Verified and secure medication handling</p>
                            </div>
                        </div>
                    </div>

                    <div id="installation" class="card">
                        <h3>Installation</h3>
                        <p>Follow these steps to set up the development environment:</p>
                        <div class="code-block">
                            <pre><code class="language-bash"># Clone the repository
git clone https://github.com/lucifron28/AkbayMed_User.git
cd AkbayMed_User

# Install dependencies
flutter pub get

# Create .env file
cp .env.example .env</code></pre>
                        </div>
                    </div>

                    <div id="env-config" class="card">
                        <h3>Environment Configuration</h3>
                        <p>Create a `.env` file in the root directory with the following variables:</p>
                        <div class="code-block">
                            <pre><code class="language-bash"># Supabase Configuration
SUPABASE_URL=your_supabase_project_url
SUPABASE_ANON_KEY=your_supabase_anon_key

# Optional: Development Configuration
DEBUG=true
LOG_LEVEL=debug</code></pre>
                        </div>
                        <div class="note">
                            <h4>Getting Supabase Credentials:</h4>
                            <ol>
                                <li>Go to your Supabase project dashboard</li>
                                <li>Click on the "Settings" icon in the sidebar</li>
                                <li>Select "API" from the settings menu</li>
                                <li>Copy the "Project URL" and paste it as your SUPABASE_URL</li>
                                <li>Copy the "anon public" key and paste it as your SUPABASE_ANON_KEY</li>
                            </ol>
                        </div>
                    </div>

                    <div id="prerequisites" class="card">
                        <h3>Prerequisites</h3>
                        <div class="prerequisites-grid">
                            <div class="prerequisite-item">
                                <i class="fab fa-flutter"></i>
                                <span>Flutter SDK 3.x</span>
                            </div>
                            <div class="prerequisite-item">
                                <i class="fas fa-code"></i>
                                <span>Android Studio / VS Code</span>
                            </div>
                            <div class="prerequisite-item">
                                <i class="fab fa-android"></i>
                                <span>Android SDK (API 26+)</span>
                            </div>
                            <div class="prerequisite-item">
                                <i class="fab fa-git-alt"></i>
                                <span>Git</span>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Features Section -->
                <section id="features">
                    <div class="section-header">
                        <i class="fas fa-star"></i>
                        <h2>Features</h2>
                    </div>
                    
                    <div id="authentication" class="card">
                        <h3>Authentication</h3>
                        <p>Secure and user-friendly authentication system for both donors and patients.</p>
                        <div class="feature-details">
                            <div class="feature-list">
                                <ul>
                                    <li><i class="fas fa-check"></i> Email and password-based authentication</li>
                                    <li><i class="fas fa-check"></i> User registration with role selection</li>
                                    <li><i class="fas fa-check"></i> Secure session management</li>
                                    <li><i class="fas fa-check"></i> Profile management with avatar upload</li>
                                </ul>
                            </div>
                            <div class="feature-images">
                                <div class="feature-image">
                                    <img src="assets/screenshots/login-screen.jpg" alt="Login Screen" />
                                    <p class="image-caption">Login Screen</p>
                                </div>
                                <div class="feature-image">
                                    <img src="assets/screenshots/registration-screen.jpg" alt="Registration Screen" />
                                    <p class="image-caption">Registration Screen</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="medication-donation" class="card">
                        <h3>Medication Donation</h3>
                        <p>Streamlined process for donors to contribute medications to those in need.</p>
                        <div class="feature-details">
                            <div class="feature-list">
                                <ul>
                                    <li><i class="fas fa-check"></i> Donation submission with medication details</li>
                                    <li><i class="fas fa-check"></i> Integration with openFDA API for medication verification</li>
                                    <li><i class="fas fa-check"></i> Expiration date tracking</li>
                                    <li><i class="fas fa-check"></i> Donation history and status tracking</li>
                                </ul>
                            </div>
                            <div class="feature-images">
                                <div class="feature-image">
                                    <img src="assets/screenshots/donation-screen.jpg" alt="Donation Screen" />
                                    <p class="image-caption">Donation Screen</p>
                                </div>
                                <div class="feature-image">
                                    <img src="assets/screenshots/search-suggestions.jpg" alt="Medication Search" />
                                    <p class="image-caption">Medication Search</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="medication-requests" class="card">
                        <h3>Medication Requests</h3>
                        <p>Easy-to-use interface for patients to request needed medications.</p>
                        <div class="feature-details">
                            <div class="feature-list">
                                <ul>
                                    <li><i class="fas fa-check"></i> Browse available medications</li>
                                    <li><i class="fas fa-check"></i> Submit medication requests</li>
                                    <li><i class="fas fa-check"></i> Track request status</li>
                                    <li><i class="fas fa-check"></i> View request history</li>
                                </ul>
                            </div>
                            <div class="feature-image">
                                <img src="assets/screenshots/request-screen.jpg" alt="Request Screen" />
                                <p class="image-caption">Request Screen</p>
                            </div>
                        </div>
                    </div>

                    <div id="user-profile" class="card">
                        <h3>User Profile</h3>
                        <p>Personalized user experience with comprehensive profile management.</p>
                        <div class="feature-details">
                            <div class="feature-list">
                                <ul>
                                    <li><i class="fas fa-check"></i> View and edit personal information</li>
                                    <li><i class="fas fa-check"></i> Track donation/request history</li>
                                    <li><i class="fas fa-check"></i> Update profile picture</li>
                                    <li><i class="fas fa-check"></i> Manage account settings</li>
                                </ul>
                            </div>
                            <div class="feature-images">
                                <div class="feature-image">
                                    <img src="assets/screenshots/profile-screen.jpg" alt="Profile Screen" />
                                    <p class="image-caption">Profile Screen</p>
                                </div>
                                <div class="feature-image">
                                    <img src="assets/screenshots/update-profile-feature.jpg" alt="Update Profile" />
                                    <p class="image-caption">Update Profile</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="home-dashboard" class="card">
                        <h3>Home Dashboard</h3>
                        <p>Centralized hub for all user activities and quick access to features.</p>
                        <div class="feature-details">
                            <div class="feature-list">
                                <ul>
                                    <li><i class="fas fa-check"></i> Personalized welcome screen</li>
                                    <li><i class="fas fa-check"></i> Activity tracking</li>
                                    <li><i class="fas fa-check"></i> Quick access to main features</li>
                                    <li><i class="fas fa-check"></i> Recent transactions overview</li>
                                </ul>
                            </div>
                            <div class="feature-image">
                                <img src="assets/screenshots/home-screen.jpg" alt="Home Screen" />
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Tech Stack Section -->
                <section id="tech-stack">
                    <div class="section-header">
                        <i class="fas fa-layer-group"></i>
                        <h2>Tech Stack</h2>
                    </div>
                    
                    <div id="frontend" class="card">
                        <h3>Frontend</h3>
                        <div class="tech-grid">
                            <div class="tech-item">
                                <i class="fab fa-flutter"></i>
                                <h4>Flutter 3.29.3</h4>
                                <p>Cross-platform UI framework</p>
                            </div>
                            <div class="tech-item">
                                <i class="fas fa-code"></i>
                                <h4>Dart 3.7.2</h4>
                                <p>Programming language</p>
                            </div>
                            <div class="tech-item">
                                <i class="fas fa-palette"></i>
                                <h4>Material 3</h4>
                                <p>UI Components</p>
                            </div>
                        </div>
                    </div>

                    <div id="backend" class="card">
                        <h3>Backend</h3>
                        <div class="tech-grid">
                            <div class="tech-item">
                                <i class="fas fa-shield-alt"></i>
                                <h4>Supabase Auth</h4>
                                <p>Authentication service</p>
                            </div>
                            <div class="tech-item">
                                <i class="fas fa-database"></i>
                                <h4>Supabase PostgreSQL</h4>
                                <p>Database service</p>
                            </div>
                            <div class="tech-item">
                                <i class="fas fa-cloud"></i>
                                <h4>Supabase Storage</h4>
                                <p>File storage service</p>
                            </div>
                        </div>
                    </div>

                    <div id="dependencies" class="card">
                        <h3>Dependencies</h3>
                        <div class="code-block">
                            <pre><code class="language-yaml">dependencies:
  flutter:
    sdk: flutter
  supabase_flutter: ^2.9.0
  flutter_dotenv: ^5.2.1
  logger: ^2.5.0
  image_picker: ^1.0.4
  path: ^1.8.3
  permission_handler: ^11.0.0
  http: ^1.4.0
  intl: ^0.19.0</code></pre>
                        </div>
                    </div>
                </section>

                <!-- API Integration Section -->
                <section id="api-integration">
                    <div class="section-header">
                        <i class="fas fa-code"></i>
                        <h2>API Integration</h2>
                    </div>

                    <div id="openfda-api" class="card">
                        <h3>openFDA API</h3>
                        <p>Integration with the openFDA API for medication verification and information.</p>
                        <div class="code-block">
                            <pre><code class="language-dart">Future<Map<String, dynamic>> searchMedication(String brandName) async {
  final response = await http.get(
    Uri.parse('https://api.fda.gov/drug/label.json?search=brand_name:$brandName&limit=1'),
  );

  if (response.statusCode == 200) {
    return json.decode(response.body);
  } else {
    throw Exception('Failed to load medication data');
  }
}</code></pre>
                        </div>
                    </div>

                    <div id="supabase-integration" class="card">
                        <h3>Supabase Integration</h3>
                        <p>Authentication, database, and storage integration with Supabase.</p>
                        <div class="code-block">
                            <pre><code class="language-dart">// Authentication
final supabase = Supabase.instance.client;
final response = await supabase.auth.signInWithPassword(
  email: email,
  password: password,
);

// Database Operations
final data = await supabase
  .from('donations')
  .select()
  .order('created_at', ascending: false);</code></pre>
                        </div>
                    </div>
                </section>

                <!-- Database Section -->
                <section id="database">
                    <div class="section-header">
                        <i class="fas fa-database"></i>
                        <h2>Database</h2>
                    </div>

                    <div id="tables" class="card">
                        <h3>Tables</h3>
                        <div class="code-block">
                            <pre><code class="language-sql">-- Users Table
CREATE TABLE users (
    id UUID PRIMARY KEY REFERENCES auth.users(id),
    name TEXT NOT NULL,
    email TEXT NOT NULL,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    avatar_url TEXT,
    is_verified BOOLEAN NOT NULL DEFAULT TRUE,
    donation_count BIGINT NOT NULL DEFAULT 0
);

-- Medications Table
CREATE TABLE medications (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    name TEXT NOT NULL,
    description TEXT,
    category TEXT NOT NULL,
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW()
);

-- Donations Table
CREATE TABLE donations (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    donor_id UUID NOT NULL REFERENCES users(id),
    medication_id UUID NOT NULL REFERENCES medications(id),
    quantity INTEGER NOT NULL,
    expiration_date DATE NOT NULL,
    -- Note: Default 'approved' status is for prototype demonstration purposes only
    -- In production, this should be 'pending' with proper approval workflow
    status VARCHAR NOT NULL DEFAULT 'approved',
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW()
);

-- Requests Table
CREATE TABLE requests (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    patient_id UUID NOT NULL REFERENCES users(id),
    medication_id UUID NOT NULL REFERENCES medications(id),
    quantity INTEGER NOT NULL,
    -- Note: Default 'approved' status is for prototype demonstration purposes only
    -- In production, this should be 'pending' with proper approval workflow
    status VARCHAR NOT NULL DEFAULT 'approved',
    created_at TIMESTAMP WITHOUT TIME ZONE NOT NULL DEFAULT NOW()
);

-- Inventory Table
CREATE TABLE inventory (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    medication_id UUID REFERENCES medications(id),
    quantity INTEGER NOT NULL DEFAULT 0,
    expiration_date DATE,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);

-- Appointments Table
CREATE TABLE appointments (
    id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID REFERENCES users(id),
    donation_id UUID REFERENCES donations(id),
    request_id UUID REFERENCES requests(id),
    appointment_date TIMESTAMP WITHOUT TIME ZONE NOT NULL,
    type VARCHAR NOT NULL,
    created_at TIMESTAMP WITHOUT TIME ZONE DEFAULT NOW()
);</code></pre>
                        </div>
                    </div>

                    <div id="table-relationships" class="card">
                        <h3>Table Relationships</h3>
                        <ul>
                            <li><strong>Users</strong> (1) → (N) <strong>Donations</strong>: One user can make multiple donations</li>
                            <li><strong>Users</strong> (1) → (N) <strong>Requests</strong>: One user can make multiple requests</li>
                            <li><strong>Users</strong> (1) → (N) <strong>Appointments</strong>: One user can have multiple appointments</li>
                            <li><strong>Medications</strong> (1) → (N) <strong>Donations</strong>: One medication can be donated multiple times</li>
                            <li><strong>Medications</strong> (1) → (N) <strong>Requests</strong>: One medication can be requested multiple times</li>
                            <li><strong>Medications</strong> (1) → (1) <strong>Inventory</strong>: One medication has one inventory record</li>
                            <li><strong>Donations</strong> (1) → (N) <strong>Appointments</strong>: One donation can have multiple appointments</li>
                            <li><strong>Requests</strong> (1) → (N) <strong>Appointments</strong>: One request can have multiple appointments</li>
                        </ul>
                    </div>

                    <div id="key-features" class="card">
                        <h3>Key Features</h3>
                        <ul>
                            <li>UUID primary keys for all tables</li>
                            <li>Automatic timestamp management for created_at and updated_at</li>
                            <li>Foreign key constraints for referential integrity</li>
                            <li>Default values for status fields</li>
                            <li>Proper indexing on frequently queried columns</li>
                            <li>Timestamp with time zone for user-related timestamps</li>
                            <li>Timestamp without time zone for business logic timestamps</li>
                        </ul>
                    </div>

                    <div id="database-functions" class="card">
                        <h3>Database Functions</h3>
                        
                        <div id="donation-count" class="trigger-section">
                            <h4>Donation Count Management</h4>
                            <p>Automatically tracks and updates the donation count for users when a donation is approved.</p>
                            <div class="code-block">
                                <pre><code class="language-sql">CREATE OR REPLACE FUNCTION increment_donation_count()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT' AND NEW.status = 'approved') OR
       (TG_OP = 'UPDATE' AND NEW.status = 'approved' AND OLD.status != 'approved') THEN
        UPDATE public.users
        SET donation_count = donation_count + 1
        WHERE id = NEW.donor_id;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER donation_count_trigger
AFTER INSERT OR UPDATE ON donations
FOR EACH ROW
EXECUTE FUNCTION increment_donation_count();</code></pre>
                            </div>
                        </div>

                        <div id="donation-appointment" class="trigger-section">
                            <h4>Donation Appointment Management</h4>
                            <p>Automatically creates dropoff appointments for approved donations, scheduled 3 days after approval.</p>
                            <div class="code-block">
                                <pre><code class="language-sql">CREATE OR REPLACE FUNCTION create_donation_appointment()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT' AND NEW.status = 'approved') OR
       (TG_OP = 'UPDATE' AND NEW.status = 'approved' AND OLD.status != 'approved') THEN
        IF NOT EXISTS (
            SELECT 1 FROM appointments
            WHERE donation_id = NEW.id
        ) THEN
            INSERT INTO appointments (
                user_id,
                donation_id,
                appointment_date,
                type,
                created_at
            )
            VALUES (
                NEW.donor_id,
                NEW.id,
                CURRENT_TIMESTAMP + INTERVAL '3 days',
                'dropoff',
                NOW()
            );
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER donation_appointment_trigger
AFTER INSERT OR UPDATE ON donations
FOR EACH ROW
EXECUTE FUNCTION create_donation_appointment();</code></pre>
                            </div>
                        </div>

                        <div id="request-appointment" class="trigger-section">
                            <h4>Request Appointment Management</h4>
                            <p>Automatically creates pickup appointments for approved requests, scheduled 3 days after approval.</p>
                            <div class="code-block">
                                <pre><code class="language-sql">CREATE OR REPLACE FUNCTION create_request_appointment()
RETURNS TRIGGER AS $$
BEGIN
    IF (TG_OP = 'INSERT' AND NEW.status = 'approved') OR
       (TG_OP = 'UPDATE' AND NEW.status = 'approved' AND OLD.status != 'approved') THEN
        IF NOT EXISTS (
            SELECT 1 FROM appointments
            WHERE request_id = NEW.id
        ) THEN
            INSERT INTO appointments (
                user_id,
                request_id,
                appointment_date,
                type,
                created_at
            )
            VALUES (
                NEW.patient_id,
                NEW.id,
                CURRENT_TIMESTAMP + INTERVAL '3 days',
                'pickup',
                NOW()
            );
        END IF;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER request_appointment_trigger
AFTER INSERT OR UPDATE ON requests
FOR EACH ROW
EXECUTE FUNCTION create_request_appointment();</code></pre>
                            </div>
                        </div>

                        <div id="inventory-management" class="trigger-section">
                            <h4>Inventory Management</h4>
                            <p>Manages inventory levels for both donations and requests, including FIFO allocation and expiration date tracking.</p>
                            
                            <h5>Request Inventory Update</h5>
                            <div class="code-block">
                                <pre><code class="language-sql">CREATE OR REPLACE FUNCTION update_inventory_from_request()
RETURNS TRIGGER AS $$
DECLARE
    total_available INTEGER;
    remaining_request INTEGER := NEW.quantity;
    rec RECORD;
BEGIN
    IF (TG_OP = 'INSERT' AND NEW.status = 'approved' AND NEW.medication_id IS NOT NULL) OR
       (TG_OP = 'UPDATE' AND NEW.status = 'approved' AND OLD.status != 'approved' AND NEW.medication_id IS NOT NULL) THEN
        SELECT COALESCE(SUM(quantity), 0) INTO total_available
        FROM inventory
        WHERE medication_id = NEW.medication_id
        AND (expiration_date IS NULL OR expiration_date >= CURRENT_DATE);

        IF total_available < NEW.quantity THEN
            RAISE EXCEPTION 'Insufficient inventory for medication_id %: requested %, available %',
                NEW.medication_id, NEW.quantity, total_available;
        END IF;

        FOR rec IN (
            SELECT id, quantity
            FROM inventory
            WHERE medication_id = NEW.medication_id
            AND (expiration_date IS NULL OR expiration_date >= CURRENT_DATE)
            AND quantity > 0
            ORDER BY COALESCE(expiration_date, '9999-12-31'::DATE) ASC
        ) LOOP
            IF remaining_request <= 0 THEN
                EXIT;
            END IF;
            DECLARE
                deduct_amount INTEGER := LEAST(remaining_request, rec.quantity);
            BEGIN
                UPDATE inventory
                SET quantity = quantity - deduct_amount,
                    updated_at = NOW()
                WHERE id = rec.id;
                remaining_request := remaining_request - deduct_amount;
            END;
        END LOOP;
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER request_inventory_trigger
AFTER INSERT OR UPDATE ON requests
FOR EACH ROW
EXECUTE FUNCTION update_inventory_from_request();</code></pre>
                            </div>

                            <h5>Donation Inventory Update</h5>
                            <div class="code-block">
                                <pre><code class="language-sql">CREATE OR REPLACE FUNCTION update_inventory_from_donation()
RETURNS TRIGGER AS $$
DECLARE
    remaining_quantity INTEGER := NEW.quantity;
    rec RECORD;
BEGIN
    IF (TG_OP = 'INSERT' AND NEW.status = 'approved' AND NEW.medication_id IS NOT NULL) OR
       (TG_OP = 'UPDATE' AND NEW.status = 'approved' AND OLD.status != 'approved' AND NEW.medication_id IS NOT NULL) THEN
        INSERT INTO inventory (
            medication_id,
            quantity,
            expiration_date,
            source,
            donation_id,
            created_at,
            updated_at
        )
        VALUES (
            NEW.medication_id,
            NEW.quantity,
            NEW.expiration_date,
            'donation',
            NEW.id,
            NOW(),
            NOW()
        );
    END IF;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

CREATE TRIGGER donation_inventory_trigger
AFTER INSERT OR UPDATE ON donations
FOR EACH ROW
EXECUTE FUNCTION update_inventory_from_donation();</code></pre>
                            </div>
                        </div>
                    </div>

                    <div id="row-level-security" class="card">
                        <h3>Row Level Security</h3>
                        <div class="code-block">
                            <pre><code class="language-sql">-- Enable RLS
ALTER TABLE users ENABLE ROW LEVEL SECURITY;
ALTER TABLE medications ENABLE ROW LEVEL SECURITY;
ALTER TABLE donations ENABLE ROW LEVEL SECURITY;
ALTER TABLE requests ENABLE ROW LEVEL SECURITY;
ALTER TABLE inventory ENABLE ROW LEVEL SECURITY;
ALTER TABLE appointments ENABLE ROW LEVEL SECURITY;

-- Users table policies
CREATE POLICY "Users can view their own profile"
    ON users FOR SELECT
    USING (auth.uid() = id);

CREATE POLICY "Users can update their own profile"
    ON users FOR UPDATE
    USING (auth.uid() = id);

-- Medications table policies
CREATE POLICY "Anyone can view medications"
    ON medications FOR SELECT
    USING (true);

CREATE POLICY "Only admins can modify medications"
    ON medications FOR ALL
    USING (auth.uid() IN (SELECT id FROM users WHERE role = 'admin'));

-- Donations table policies
CREATE POLICY "Users can view their own donations"
    ON donations FOR SELECT
    USING (auth.uid() = donor_id);

CREATE POLICY "Users can create donations"
    ON donations FOR INSERT
    WITH CHECK (auth.uid() = donor_id);

CREATE POLICY "Users can update their own donations"
    ON donations FOR UPDATE
    USING (auth.uid() = donor_id);

-- Requests table policies
CREATE POLICY "Users can view their own requests"
    ON requests FOR SELECT
    USING (auth.uid() = patient_id);

CREATE POLICY "Users can create requests"
    ON requests FOR INSERT
    WITH CHECK (auth.uid() = patient_id);

CREATE POLICY "Users can update their own requests"
    ON requests FOR UPDATE
    USING (auth.uid() = patient_id);

-- Inventory table policies
CREATE POLICY "Anyone can view inventory"
    ON inventory FOR SELECT
    USING (true);

CREATE POLICY "Only admins can modify inventory"
    ON inventory FOR ALL
    USING (auth.uid() IN (SELECT id FROM users WHERE role = 'admin'));

-- Appointments table policies
CREATE POLICY "Users can view their own appointments"
    ON appointments FOR SELECT
    USING (auth.uid() = user_id);

CREATE POLICY "Users can create appointments"
    ON appointments FOR INSERT
    WITH CHECK (auth.uid() = user_id);

CREATE POLICY "Users can update their own appointments"
    ON appointments FOR UPDATE
    USING (auth.uid() = user_id);</code></pre>
                        </div>
                    </div>

                    <div id="storage-configuration" class="card">
                        <h3>Storage Configuration</h3>
                        <div class="code-block">
                            <pre><code class="language-sql">-- Create storage bucket for avatars
INSERT INTO storage.buckets (id, name, public) VALUES ('avatars', 'avatars', true);

-- Set up storage policies
CREATE POLICY "Avatar images are publicly accessible"
ON storage.objects FOR SELECT
USING (bucket_id = 'avatars');

CREATE POLICY "Users can upload their own avatar"
ON storage.objects FOR INSERT
WITH CHECK (bucket_id = 'avatars' AND auth.uid() = owner);

CREATE POLICY "Users can update their own avatar"
ON storage.objects FOR UPDATE
USING (bucket_id = 'avatars' AND auth.uid() = owner);

CREATE POLICY "Users can delete their own avatar"
ON storage.objects FOR DELETE
USING (bucket_id = 'avatars' AND auth.uid() = owner);</code></pre>
                        </div>
                    </div>

                    <div id="error-handling" class="card">
                        <h3>Error Handling</h3>
                        <ul>
                            <li>Inventory validation before updates</li>
                            <li>Exception handling for insufficient stock</li>
                            <li>Duplicate appointment prevention</li>
                            <li>Transaction management for data consistency</li>
                        </ul>
                    </div>
                </section>

                <!-- UI/UX Design Section -->
                <section id="ui-ux">
                    <div class="section-header">
                        <i class="fas fa-paint-brush"></i>
                        <h2>UI/UX Design</h2>
                    </div>

                    <div id="design-system" class="card">
                        <h3>Design System</h3>
                        <p>AkbayMed follows Material Design 3 guidelines for a consistent and modern user experience.</p>
                        <div class="design-grid">
                            <div class="design-item">
                                <h4>Components</h4>
                                <ul>
                                    <li>Material 3 widgets</li>
                                    <li>Custom themed components</li>
                                    <li>Responsive layouts</li>
                                </ul>
                            </div>
                            <div class="design-item">
                                <h4>Layout</h4>
                                <ul>
                                    <li>Grid-based system</li>
                                    <li>Consistent spacing</li>
                                    <li>Responsive breakpoints</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <div id="color-scheme" class="card">
                        <h3>Color Scheme</h3>
                        <div class="color-grid">
                            <div class="color-item">
                                <div class="color-box" style="background-color: #00796B;"></div>
                                <div class="color-info">
                                    <h4>Primary</h4>
                                    <p>Teal 700 (#00796B)</p>
                                </div>
                            </div>
                            <div class="color-item">
                                <div class="color-box" style="background-color: #004D40;"></div>
                                <div class="color-info">
                                    <h4>Secondary</h4>
                                    <p>Teal 900 (#004D40)</p>
                                </div>
                            </div>
                            <div class="color-item">
                                <div class="color-box" style="background-color: #B2DFDB;"></div>
                                <div class="color-info">
                                    <h4>Accent</h4>
                                    <p>Teal 100 (#B2DFDB)</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="typography" class="card">
                        <h3>Typography</h3>
                        <div class="typography-grid">
                            <div class="typography-item">
                                <h4>Headings</h4>
                                <p class="heading-1">Heading 1</p>
                                <p class="heading-2">Heading 2</p>
                                <p class="heading-3">Heading 3</p>
                            </div>
                            <div class="typography-item">
                                <h4>Body Text</h4>
                                <p class="body-large">Body Large</p>
                                <p class="body-medium">Body Medium</p>
                                <p class="body-small">Body Small</p>
                            </div>
                        </div>
                    </div>
                </section>
            </div>
        </main>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-yaml.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-dart.min.js"></script>
    <script src="js/main.js"></script>
</body>
</html> 